<html>

<body>
  <div>
    <div id="AmazonPayButton"></div>
    <div id="walletWidgetDiv" style="height: 250px;"></div>
    <div id="consentWidgetDiv" style="height: 100px;"></div>
    <div id="buyForm" style="display: none;">
      <input type="hidden" id="amazonBillingAgreementId" name="amazonBillingAgreementId" value="" />
      <button onclick="postPaymentBuy()">購入する</button>
    </div>
    <div id="buyComplete" style="display: none;">
      購入が完了しました。
    </div>
  </div>

  <script type='text/javascript'>
    window.onAmazonLoginReady = function () {
      amazon.Login.setClientId("{{ .AmazonPayClientID }}");
    };
    window.onAmazonPaymentsReady = function () {
      showLoginButton();
    };
  </script>

  <script type="text/javascript">

    function showLoginButton() {
      var authRequest;
      OffAmazonPayments.Button("AmazonPayButton", "{{ .AmazonPaySellerID }}", {
        type: "PwA",
        color: "Gold",
        size: "large",

        authorization: function () {
          loginOptions = { scope: "profile payments:widget", popup: true };
          authRequest = amazon.Login.authorize(loginOptions, function (t) {
            // console.log(t.access_token);
            // console.log(t.expires_in);
            // console.log(t.token_type);
            showWalletWidget(null);
          });
        },
        onError: function (error) {
          console.log('OffAmazonPayments.Button', error.getErrorCode(), error.getErrorMessage());
        }
      });
    }

    function showWalletWidget(billingAgreementId) {
      new OffAmazonPayments.Widgets.Wallet({
        sellerId: "{{ .AmazonPaySellerID }}",
        agreementType: 'BillingAgreement',
        amazonBillingAgreementId: billingAgreementId,
        onReady: function (billingAgreement) {
          console.log(billingAgreement.getAmazonBillingAgreementId());
          showConsentWidget(billingAgreement);
        },
        onPaymentSelect: function () {
        },
        design: {
          designMode: 'responsive'
        },
        onError: function (error) {
          // エラー処理 
          // エラーが発生した際にonErrorハンドラーを使って処理することをお勧めします。 
          // @see https://payments.amazon.com/documentation/lpwa/201954960
          console.log('OffAmazonPayments.Widgets.Wallet', error.getErrorCode(), error.getErrorMessage());
        }
      }).bind("walletWidgetDiv");
    }

    function showConsentWidget(billingAgreement) {
      var amazonBillingAgreementId = billingAgreement.getAmazonBillingAgreementId();
      document.getElementById("amazonBillingAgreementId").value = amazonBillingAgreementId;
      // Consent
      new OffAmazonPayments.Widgets.Consent({
        sellerId: "{{ .AmazonPaySellerID }}",
        amazonBillingAgreementId: amazonBillingAgreementId,
        onReady: function (billingAgreementConsentStatus) {
          var consentStatus = billingAgreementConsentStatus.getConsentStatus();
          toggleBuyButton(consentStatus == 'true');
        },
        onConsent: function (billingAgreementConsentStatus) {
          var consentStatus = billingAgreementConsentStatus.getConsentStatus();
          toggleBuyButton(consentStatus == 'true');
        },
        design: {
          designMode: 'responsive'
        },
        onError: function (error) {
          // エラー処理 
          // エラーが発生した際にonErrorハンドラーを使って処理することをお勧めします。 
          // @see https://payments.amazon.com/documentation/lpwa/201954960
          console.log('OffAmazonPayments.Widgets.Consent', error.getErrorCode(), error.getErrorMessage());
        }
      }).bind("consentWidgetDiv");
    }

    function toggleBuyButton(consentStatus) {
      if (consentStatus) {
        document.getElementById("buyForm").style.display = "block";
      } else {
        document.getElementById("buyForm").style.display = "none";
      }
    }

    function postPaymentBuy() {
      var billingAgreementId = document.getElementById("amazonBillingAgreementId").value;
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/payment/buy');
      xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
      xhr.send(`amazonBillingAgreementId=${billingAgreementId}`);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          console.log(xhr.responseText);
          document.getElementById("buyComplete").style.display = "block";
        }
      };
    }
  </script>
  <script type="text/javascript" src="https://static-fe.payments-amazon.com/OffAmazonPayments/jp/sandbox/lpa/js/Widgets.js" async></script>
</body>

</html>